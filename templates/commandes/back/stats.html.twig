{% extends "layoutAdmin.html.twig" %}
{% block stylesheets %}
<!-- BEGIN PAGE LEVEL PLUGIN STYLES -->
<link href="{{ asset('template/assets/global/plugins/bootstrap-daterangepicker/daterangepicker-bs3.css') }}" rel="stylesheet" type="text/css"/>
<link href="{{ asset('template/assets/global/plugins/fullcalendar/fullcalendar.min.css') }}" rel="stylesheet" type="text/css"/>
<link href="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/jqvmap.css') }}" rel="stylesheet" type="text/css"/>
<link href="{{ asset('template/assets/global/plugins/morris/morris.css') }}" rel="stylesheet" type="text/css">
<!-- END PAGE LEVEL PLUGIN STYLES -->
<!-- BEGIN PAGE STYLES -->
<link href="{{ asset('template/assets/admin/pages/css/tasks.css') }}" rel="stylesheet" type="text/css"/>
<!-- END PAGE STYLES -->
<style type="text/css">
    .number-stats .stat-left{
        float: inherit;
    }
    .number-stats .stat-left .stat-number{
        text-align: center !important;
    }
    #table-stats tbody tr td{
        font-weight: 100;
    }
</style>
{% endblock %}
{% block title %}Tableau de bord{% endblock %}
{% block body %}
    <div class="page-content-wrapper">
        <div class="page-content">
            <!-- BEGIN PAGE HEAD -->
            <div class="page-head">
                <!-- BEGIN PAGE TITLE -->
                <div class="page-title">
                    <h1>Commandes</h1>
                </div>
                <!-- END PAGE TITLE -->
            </div>
            <!-- END PAGE HEAD -->
            <!-- BEGIN PAGE BREADCRUMB -->
            <ul class="page-breadcrumb breadcrumb hide">
                <li>
                    <a href="javascript:;">Home</a><i class="fa fa-circle"></i>
                </li>
                <li class="active">
                    Dashboard
                </li>
            </ul>
            <!-- END PAGE BREADCRUMB -->
            <!-- BEGIN PAGE CONTENT INNER -->
            <div class="row margin-top-10">
                <div class="col-md-12 col-sm-12">
                    <!-- BEGIN PORTLET-->
                    <div class="portlet light ">
                        <div class="portlet-title">
                            <div class="caption caption-md">
                                <i class="icon-bar-chart theme-font-color hide"></i>
                                <span class="caption-subject theme-font-color bold uppercase">statistiques et rapports</span>
                            </div>
                            <div class="actions">
                                <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#modalFilterCmd">Filtrer</button>
                                <div class="modal fade" id="modalFilterCmd" role="dialog">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                              <button type="button" class="close" data-dismiss="modal">&times;</button>
                                              <h4 class="modal-title">Filtre Commandes</h4>
                                            </div>
                                            <div class="modal-body">
                                                <h3>Global</h3>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <select id="filterCmdGlobal" class="form-control">
                                                            <option value="this_year">Cette année</option>
                                                            {% for k,month in months %}
                                                                <option value="{{k}}">{{month}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <select class="filter-by form-control">
                                                            <option value="0">Sélectionner</option>
                                                            <option value="1">Par marchand</option>
                                                            <option value="2">Par catégorie</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <hr>
                                                    </div>
                                                    <div class="col-sm-6" id="categoriesMereBloc" style="display: none;">
                                                        <select class="categoriesMere form-control">
                                                            <option value="0">Sélectionner</option>
                                                            {% for category in categories %}
                                                                <option value="{{category.id}}">{{category.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-6" id="sousCategoryBloc" style="display: none;">
                                                        <select class="sousCategory form-control">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" id="confirmFilterGlobal" class="btn btn-info">Valider</button>
                                                <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="portlet-body">
                            <div id="myChart" style="width:100%; height:500px;"></div>
                            <table id="table-stats" style="display: none;" class="table table-hover">
                                <thead>
                                    <tr></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- END PORTLET-->
            </div>
            <!-- END PAGE CONTENT INNER -->
        </div>
    </div>
{% endblock %}
{% block javascripts %}
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script src="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/jquery.vmap.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.russia.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.world.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.europe.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.germany.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/maps/jquery.vmap.usa.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/jqvmap/jqvmap/data/jquery.vmap.sampledata.js') }}" type="text/javascript"></script>
<!-- IMPORTANT! fullcalendar depends on jquery-ui.min.js for drag & drop support -->
<script src="{{ asset('template/assets/global/plugins/morris/morris.min.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/morris/raphael-min.js') }}" type="text/javascript"></script>
<script src="{{ asset('template/assets/global/plugins/jquery.sparkline.min.js') }}" type="text/javascript"></script>
<!-- END PAGE LEVEL PLUGINS -->
<script type="text/javascript" src="{{ asset('custom/js/loader.js') }}"></script>
<script type="text/javascript" src="{{ asset('custom/js/dash.js') }}"></script>
<script>

google.charts.load('current',{packages:['corechart']});
google.charts.setOnLoadCallback(drawChart);
    $(document).ready(function () {
        var bycategory = false;
        var bymarchand = false;
        var categoriesMere = 0;
        var sousCategory = $('.sousCategory').val() ? $('.sousCategory').val() : 0;
        $(".filter-by").change(function (argument) {
            if($(this).val() == 2) { 
                $('#categoriesMereBloc').show();bymarchand = false;bycategory = true;

            }
            if($(this).val() == 1) { $('#categoriesMereBloc').hide();bymarchand = true;bycategory = false; }
            if($(this).val() == 0) { $('#categoriesMereBloc').hide();bymarchand = false;bycategory = false; }
        });
        $('.sousCategory').change(function(){
            sousCategory = $(this).val();
        });
        $('.categoriesMere').change(function(){
            var id = $(this).val();
            categoriesMere = id;
            if(id=='rien'){
                $('#sc1').prop('disabled', true);
            }else{
                var url = '{{path('dashboard_sc1_by_cm', {'cm': 'valeurselectionnee'})}}';
                url = url.replace("valeurselectionnee", id);
                $.ajax({

                    url: url,
                    method: "GET",
                    error: function ()
                    {
                        alert('une erreur');
                    },
                    beforeSend: function ()
                    {
                        
                    },
                    success: function (result)
                    {
                        $('#sousCategoryBloc').show();
                        $('.sousCategory').html(result['options']);
                    }
                });
            }
        });
        $('#confirmFilterGlobal').click(function (argument) {
            $.ajax({
                
                url: '{{ path('dashboard_cmd_filter') }}',
                method: "GET",
                data: {period:$('#filterCmdGlobal').val(), bycategory : bycategory, bymarchand : bymarchand, categoriesMere : categoriesMere, sousCategory : sousCategory},
                error: function ()
                {
                    alert('une erreur');
                },
                beforeSend: function ()
                {
                    
                },
                success: function (data)
                {
                    var commandes = data.commandes;
                    $('#table-stats').show();
                    $('#table-stats thead tr').html('<td>'+commandes[0][0]+'</td><td>'+commandes[0][1]+'</td>');
                    $('#table-stats tbody').html('');
                    if(commandes.length > 1){
                        var type = data.entity == 'Marchands' || data.entity == 'Categories' ? 'column' : 'line';
                        createChart(data.commandes, data.entity, type);
                        $.each(commandes, function( index, value ) {
                            if(index > 0){
                                $('#table-stats tbody').append('<tr><td>'+value[0]+'</td><td>'+value[1]+'</td></tr>');
                            }
                        });
                        
                    }else{
                        $('#table-stats tbody').html('<tr><td colspan="2" style="text-align: centrer;">Pas de données</td></tr>');
                    }
                    $('#modalFilterCmd').modal('toggle'); 
                }
            });
        });
    });
function createChart(result, entity, typeChart) {
     // Draw
    if(typeChart == 'line'){
        var data = new google.visualization.arrayToDataTable(result);
        // Set Options
        
        var options = {
          title: '',
          hAxis: {title: entity},
          vAxis: {title: 'Commandes'},
          legend: 'none'
        };
        var chart = new google.visualization.LineChart(document.getElementById('myChart'));

        chart.draw(data, options);
    }
    if(typeChart == 'column'){
        var data = new google.visualization.arrayToDataTable(result);

        var options = {
          title: 'Commandes',
          hAxis: {title: entity, titleTextStyle: {color: 'red'}},
                tooltip: {legend:'none',isHtml:true, textStyle: {color: '#FF0000'}, showColorCode: true}
        };

        var chart = new google.visualization.ColumnChart(document.getElementById('myChart'));
        chart.draw(data, options);
      }
}
function drawChart() {
// Set Data
var data = google.visualization.arrayToDataTable([
  ['Price', 'Commandes'],
  {{commandes|raw}}
]);
// Set Options
var options = {
  title: '',
  hAxis: {title: 'Mois'},
  vAxis: {title: ''},
  legend: 'none'
};
// Draw
var chart = new google.visualization.LineChart(document.getElementById('myChart'));
chart.draw(data, options);
}
</script>
<script>
jQuery(document).ready(function () {
    Metronic.init(); // init metronic core components
    Layout.init(); // init current layout
    Demo.init(); // init demo features
    //TableAdvanced.init();
});
</script>

{% endblock %}